{% extends "base.html" %}

{% block content %}

<div class="p-4 bg-slate-100 h-full flex-col ijhdfdscx hidden">
    <div class="flex  items-center">
        <button  type="button" title="back" class="cursor-pointer gvhbjjhvv z-20">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-left"><path d="m15 18-6-6 6-6"/></svg>
        </button>
        <h1 class="text-lg font-semi ml-4 grow -ms-8 text-center">Nouvelle tâche</h1>
    </div>
    <form class="flex flex-col mt-6 grow" onsubmit="handleSubmit(event)">
        <div class="flex flex-col gap-4">
            <div class="pb-6 bg-white px-4 focus-within:border rounded-md focus-within:border-cyan-500 ">
                <textarea type="text" name="title" id="title" class="input-field w-full py-4 outline-none rounded-md" placeholder="Que voulez-vous faire ?"></textarea>
                <div class="shrink-0 bg-border h-[1px]  mt-4"></div>
                <div class="mt-3 flex gap-2">
                    <button  type="button" title="emoji" type="submit" class="">
                        <svg class="w-6 h-6 text-slate-400" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path fill-rule="evenodd" clip-rule="evenodd" d="M1 12C1 5.92487 5.92487 1 12 1C18.0751 1 23 5.92487 23 12C23 18.0751 18.0751 23 12 23C5.92487 23 1 18.0751 1 12ZM9 10.5C9.82843 10.5 10.5 9.82843 10.5 9C10.5 8.17157 9.82843 7.5 9 7.5C8.17157 7.5 7.5 8.17157 7.5 9C7.5 9.82843 8.17157 10.5 9 10.5ZM7.39992 14.2001C7.84036 13.8697 8.4646 13.9577 8.79678 14.3959L8.80142 14.4018C8.80737 14.4093 8.81869 14.4234 8.83523 14.4431C8.86838 14.4826 8.92211 14.5442 8.99535 14.6207C9.14264 14.7744 9.36399 14.9829 9.65059 15.1913C10.2277 15.611 11.0254 16.0001 11.9999 16.0001C12.9744 16.0001 13.7722 15.611 14.3492 15.1913C14.6359 14.9829 14.8572 14.7744 15.0045 14.6207C15.0777 14.5442 15.1315 14.4826 15.1646 14.4431C15.1812 14.4234 15.1925 14.4093 15.1984 14.4018L15.2031 14.3959C15.5352 13.9577 16.1595 13.8697 16.5999 14.2001C17.0417 14.5314 17.1313 15.1582 16.7999 15.6001L16.7989 15.6014C16.6918 15.7435 16.5714 15.8762 16.4485 16.0045C16.2364 16.2258 15.9265 16.5172 15.5256 16.8088C14.7277 17.3891 13.5254 18.0001 11.9999 18.0001C10.4744 18.0001 9.27219 17.3891 8.47425 16.8088C8.07335 16.5172 7.76344 16.2258 7.55137 16.0045C7.42882 15.8766 7.30914 15.7443 7.20208 15.6029C6.87354 15.1664 6.96219 14.5284 7.39992 14.2001ZM16.5 9C16.5 9.82843 15.8284 10.5 15 10.5C14.1716 10.5 13.5 9.82843 13.5 9C13.5 8.17157 14.1716 7.5 15 7.5C15.8284 7.5 16.5 8.17157 16.5 9Z" class="fill-yellow-500"/>
                        </svg>
                    </button>
                    <label for="imagefile"  class="">
                      <span class="sr-only">chose image</span>
                        <svg class="w-6 h-6"  viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path fill-rule="evenodd" clip-rule="evenodd" d="M9.77778 21H14.2222C17.3433 21 18.9038 21 20.0248 20.2646C20.51 19.9462 20.9267 19.5371 21.251 19.0607C22 17.9601 22 16.4279 22 13.3636C22 10.2994 22 8.76721 21.251 7.6666C20.9267 7.19014 20.51 6.78104 20.0248 6.46268C19.3044 5.99013 18.4027 5.82123 17.022 5.76086C16.3631 5.76086 15.7959 5.27068 15.6667 4.63636C15.4728 3.68489 14.6219 3 13.6337 3H10.3663C9.37805 3 8.52715 3.68489 8.33333 4.63636C8.20412 5.27068 7.63685 5.76086 6.978 5.76086C5.59733 5.82123 4.69555 5.99013 3.97524 6.46268C3.48995 6.78104 3.07328 7.19014 2.74902 7.6666C2 8.76721 2 10.2994 2 13.3636C2 16.4279 2 17.9601 2.74902 19.0607C3.07328 19.5371 3.48995 19.9462 3.97524 20.2646C5.09624 21 6.65675 21 9.77778 21ZM12 9.27273C9.69881 9.27273 7.83333 11.1043 7.83333 13.3636C7.83333 15.623 9.69881 17.4545 12 17.4545C14.3012 17.4545 16.1667 15.623 16.1667 13.3636C16.1667 11.1043 14.3012 9.27273 12 9.27273ZM12 10.9091C10.6193 10.9091 9.5 12.008 9.5 13.3636C9.5 14.7192 10.6193 15.8182 12 15.8182C13.3807 15.8182 14.5 14.7192 14.5 13.3636C14.5 12.008 13.3807 10.9091 12 10.9091ZM16.7222 10.0909C16.7222 9.63904 17.0953 9.27273 17.5556 9.27273H18.6667C19.1269 9.27273 19.5 9.63904 19.5 10.0909C19.5 10.5428 19.1269 10.9091 18.6667 10.9091H17.5556C17.0953 10.9091 16.7222 10.5428 16.7222 10.0909Z" fill="#1C274C"/>
                        </svg>
                    </label>
                    <input class="hidden" accept="image/*" type="file" name="imagefile" id="imagefile">
                </div>
            </div>
            <div class="flex flex-col gap-2">
                <label for="priority" class="text-sm font-medium text-slate-600">Priorité</label>
                <select name="priority" id="priority" class="input-field w-full p-4 pr-6 outline-cyan-500 rounded-md bg-white text-slate-600">
                    <option value="low">Low</option>
                    <option value="medium" selected >Medium</option>
                    <option value="high">High</option>
                </select>
            </div>
            <div class="flex flex-col gap-2">
                <label for="deadline" class="text-sm font-medium text-slate-600">Dead line</label>
                <input placeholder="Date" value="2025-01-01" class="input-field w-full bg-white p-4 outline-cyan-500 rounded-md text-slate-600" type="date" name="date" id="deadline">
            </div>
        </div>
        <div class="grow mt-4">
            <button id="submit_create_from" type="submit" class="btn btn-primary w-full mt-4 bg-blue-500 inline-flex items-center justify-center text-white  py-4  rounded-md hover:bg-blue-600 focus-visible:ring-2 focus-visible:ring-blue-500">
                Ajouter
            </button>
        </div>
    </form>
</div>

<script>
    const handleSubmit = (event) => {
        const submitButton = $('#submit_create_from');
        submitButton.prop('disabled', true);
        submitButton.html(` <div class="animate-spin h-6 w-6">
            <svg  xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-loader"><path d="M12 2v4"/><path d="m16.2 7.8 2.9-2.9"/><path d="M18 12h4"/><path d="m16.2 16.2 2.9 2.9"/><path d="M12 18v4"/><path d="m4.9 19.1 2.9-2.9"/><path d="M2 12h4"/><path d="m4.9 4.9 2.9 2.9"/></svg>
        </div>`)
        event.preventDefault();
        const title = $('#title').val()
        if (title == '') {
            alert('Title cannot be empty'); 
            submitButton.prop('disabled', false);
            submitButton.html(`Create`)
             return; 
            };
        const task = {
            title,
            priority: $('#priority').val(),
            deadline: $('#deadline').val() != '' ? $('#deadline').val() : null,
        };
        try {
            $.ajax({
                type: 'POST',
                url: '/api/todos',
                data: JSON.stringify(task),
                contentType: 'application/json',
            }).then((res) => {
                setTimeout(() => {
                    window.location.reload();
                }, 400)
            })
        } catch (error) {
            console.error(error);
        } finally {
            submitButton.prop('disabled', false);
        }
    }
</script>



<div class="relative h-full  yughebdfc">
    <button id="floatind_add_button" type="button" title="Add Task" class="fixed p-2 bottom-12 left-[calc(50%--6rem)] bg-slate-900 rounded-full z-20 hover:bg-blue-600 iline-flex items-center justify-center focus-visible:ring-1 focus-visible:ring-ring shadow-lg">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 stroke-white fill-none" viewBox="0 0 24 24"  stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-plus"><path d="M5 12h14"/><path d="M12 5v14"/></svg>
    </button>
    <div class="relative">
        <img src="{{ url_for('static', filename='dist/images/banner.jpg') }}" alt="banner">
        <div class="absolute top-0 bottom-0 left-0 right-0 bg-black/40 flex flex-col items-center gap-2">
            <h6 class="uppercase text-white font-bold mt-12">Good Afternoon</h6>
            <h3 class="text-white uppercase font-bold text-3xl">{{ session.user.username }}</h3>
            <a href="{{ url_for('auth.logout') }}" class="iline-flex items-center justify-center gap-2 px-4 py-2 rounded-full bg-white/30 shadow hover:bg-white/50 text-white font-semibold">
                Logout
            </a>
        </div>
    </div>
    <div class="bg-white w-full max-w-md h-full top-48 rounded-[1.5rem] absolute p-4 overflow-hidden pb-28">
        <div class="p-1 w-full bg-slate-200 rounded-full flex gap-2 mt-4">
            <button type="button"
                data-fetch="todo"
                class="toggle-button flex-1 h-12 rounded-full   font-bold inline-flex items-center justify-center whitespace-nowrap text-sm  transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 bg-white shadow"
                title="Todo">
                TODO
            </button>
            <button type="button"
                data-fetch="done"
                class="toggle-button flex-1 font-bold h-12 rounded-full   inline-flex items-center justify-center whitespace-nowrap text-sm  transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 hover:bg-white/30"
                title="Done">
                DONE
            </button>
        </div>
        <div class="shrink-0 bg-border h-[1px] w-full mt-4"></div>
        <div class="overflow-y-auto scrollbar-none h-full rounded-b-md" id="tasks">
            <div class="flex justify-center w-full items-center mt-10" id="loader">
               <div class="animate-spin h-6 w-6">
                   <svg  xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#3B82F6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-loader"><path d="M12 2v4"/><path d="m16.2 7.8 2.9-2.9"/><path d="M18 12h4"/><path d="m16.2 16.2 2.9 2.9"/><path d="M12 18v4"/><path d="m4.9 19.1 2.9-2.9"/><path d="M2 12h4"/><path d="m4.9 4.9 2.9 2.9"/></svg>
               </div>
            </div>
        </div>
    </div>
</div>



<script>
    const toggleButton = $('.toggle-button');
    toggleButton.on("click", function () {
        $(".toggle-button").removeClass("bg-white shadow hover:bg-white/30")
        $(this).addClass("bg-white shadow")
        $(".toggle-button").not(this).addClass("hover:bg-white/30")
        if ($(this).data("fetch") == "todo") {
            fetchData(false)
        }else if ($(this).data("fetch") == "done") {
            fetchData(true)
        }
    })

    const createtaskItem = (task) => {
        const taskItem = `<div class="rounded-md"><div class="rounded-md task-item  overflow-hidden shadow bg-slate-100 hover:bg-slate-50 cursor-pointer mt-2 " id="task-item-${task.id}">
            <div class="p-4 flex  justify-between items-center" style="background-color: ${task.head_color};">
                <div class="flex items-center gap-2">
                    <span>
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                            fill="none" stroke="#fff" stroke-width="2" stroke-linecap="round"
                            stroke-linejoin="round" class="lucide lucide-flag">
                            <path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z" />
                            <line x1="4" x2="4" y1="22" y2="15" />
                        </svg>
                    </span>
                    <span class="text-white font-semibold">${task.priority} Priority</span>
                </div>
                <button title="Delete Task" class="delete-task ${task.completed ? 'delete-task-completed' : 'delete-task-uncompleted'}" data-id="${task.id}"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg></button>
            </div>
            <div>
                <div class="flex justify-between p-4">
                    <h4 class="text-xl font-semibold">${task.title}</h4>
                    <span>
                        <button class="${task.completed ? 'uncomplete-task' : 'complete-task'}" data-id="${task.id}">
                    ${
                        task.completed ? `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                        viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-square-check-big">
                        <path d="m9 11 3 3L22 4" />
                        <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11" />
                    </svg>` : `
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round" class="lucide lucide-square" ">
                        <rect width="18" height="18" x="3" y="3" rx="2" />
                    </svg>`
                    }
                </button>
                    </span>
                </div>
                <div class="shrink-0 bg-border h-[1px] w-full"></div>
                <div class="flex justify-end py-2 px-4">
                    <span class="text-sm ">
                        ${task.created_at}
                    </span>
                </div>
            </div>
        </div></div>`
        return taskItem
    }

    const fetchData = async (condition=false) => {
        $(".task-item").remove();
        $('#loader').removeClass("hidden");
        try {
            const response = await fetch('/api/todos');
            if (response.ok) {
                const tasks = await response.json();
                for (let task of tasks) {
                    $('#loader').addClass("hidden");
                    if (task.completed === condition) {
                        $('#tasks').append(createtaskItem(task));
                    }
                }
                if (tasks.length === 0) {
                    $(".task-item").remove();
                    $('#tasks').html("<div class='task-item flex justify-center mt-4 font-bold'>No task found</div>")
                }
            }
        } catch (error) {
            console.error(error);
        }finally {
            $('#loader').addClass("hidden");
        }
        }
     fetchData();

    const SetCompletedUncompleted = async (id, val) => {
        try {
            const response = await fetch('/api/todos', {
                method: 'UPDATE',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ id: id, column: 'completed', value: val })
            });
            return !!(response.ok);
            
        } catch (error) {
            console.error(error);
        }

    }

    const setCompleteButton = () => {
    }


    const deleteTask = async (id) => {
        try {
            const response = await fetch('/api/todos', {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ id: id })
            });
            return !!(response.ok);
        } catch (error) {
            console.error(error);
            return false;
        }
    }

    $(document).on("click", ".complete-task", async function(event) {
        event.preventDefault();
        const id = $(this).data("id");
        $(this).html(`<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
        viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
        stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-square-check-big">
        <path d="m9 11 3 3L22 4" />
        <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11" />
    </svg>`)
    $(`#task-item-${id}`).addClass("scale-90 opacity-80");
        await SetCompletedUncompleted(id, true).then(() => {
            $(`#task-item-${id}`).parent().addClass("bg-green-500/20");
            $(`#task-item-${id}`).addClass("slide-right");
            setTimeout(() => {
                $(`#task-item-${id}`).parent().remove()
                toggleButton.not($(".bg-white")).addClass("shadow-drop-center bg-green-200")
                setTimeout(() => {
                toggleButton.not($(".bg-white")).removeClass("shadow-drop-center bg-green-200")
                }, 400)
            }, 400)   
        })
    });
    $(document).on("click", ".uncomplete-task", async function(event) {
        event.preventDefault();
        const id = $(this).data("id");
        $(this).html(`<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
        stroke-linejoin="round" class="lucide lucide-square" ">
        <rect width="18" height="18" x="3" y="3" rx="2" />
    </svg>`)
    $(`#task-item-${id}`).addClass("scale-90 opacity-80");

        await SetCompletedUncompleted(id, false).then(() => {
            $(`#task-item-${id}`).parent().addClass("bg-yellow-500/20");
            $(`#task-item-${id}`).addClass("slide-left");
            setTimeout(() => {
                $(`#task-item-${id}`).parent().remove()
                toggleButton.not($(".bg-white")).addClass("shadow-drop-center bg-yellow-200")
                setTimeout(() => {
                toggleButton.not($(".bg-white")).removeClass("shadow-drop-center bg-yellow-200")
                }, 400)
            }, 400)   
        })
    });

    $(document).on("click", ".delete-task", async function(event){
        event.preventDefault();
        const id = $(this).data("id");
        console.log($(this).data("id"));
        $(this).html(`               <div class="animate-spin h-6 w-6">
            <svg  xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-loader"><path d="M12 2v4"/><path d="m16.2 7.8 2.9-2.9"/><path d="M18 12h4"/><path d="m16.2 16.2 2.9 2.9"/><path d="M12 18v4"/><path d="m4.9 19.1 2.9-2.9"/><path d="M2 12h4"/><path d="m4.9 4.9 2.9 2.9"/></svg>
        </div>`)
    $(`#task-item-${id}`).addClass("scale-90 opacity-80");

        await deleteTask(id).then(() => {
                if ($(this).hasClass("delete-task-completed")) {
                    $(`#task-item-${id}`).addClass("slide-right");
                } else {
                    $(`#task-item-${id}`).addClass("slide-left");
                }
                $(`#task-item-${id}`).parent().addClass("bg-red-500/40");
                setTimeout(() => {
                    $(`#task-item-${id}`).parent().remove()
                }, 400)   
            }).catch((error) => {
                console.error(error);
            }).finally(() => {
                $(this).html(`<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>`)
            })
    });


    $("#floatind_add_button").on("click", function(event) {
        $(".ijhdfdscx").removeClass("hidden");
        $(".ijhdfdscx").addClass("flex slide-bottom2");
        $(".yughebdfc").addClass("slide-bottom2");
        setTimeout(() => {
            $(".yughebdfc").addClass("hidden");
            $(".ijhdfdscx").removeClass("slide-bottom2");
            $(".yughebdfc").removeClass("slide-bottom2");
        },800)
    });

    $(".gvhbjjhvv").on("click", function(event) {
        $(".yughebdfc").removeClass("hidden");
        $(".ijhdfdscx").addClass("hidden");

        setTimeout(() => {
            $(".ijhdfdscx").removeClass("slide-top");
            $(".ijhdfdscx").removeClass("slide-top");
        },100)
    });

</script>
{% endblock content %}